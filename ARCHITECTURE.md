# Crew Architecture

## Simplified Workflow

```
PRD â†’ plan â†’ tasks â†’ work â†’ done
```

No epics. Just PRD-based task planning and execution.

## Orchestration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CREW ORCHESTRATION FLOW                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   PRD / Spec    â”‚
  â”‚   (PRD.md, etc) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: PLANNING                                            pi_messenger({   â”‚
â”‚                                                                action: "plan"}) â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          PLANNER (opus)                                  â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚   1. Explore codebase (structure, patterns, conventions)                 â”‚   â”‚
â”‚  â”‚   2. Read project documentation                                          â”‚   â”‚
â”‚  â”‚   3. Web/GitHub research (if relevant)                                   â”‚   â”‚
â”‚  â”‚   4. Gap analysis (edge cases, security, testing)                        â”‚   â”‚
â”‚  â”‚   5. Task breakdown with dependencies                                    â”‚   â”‚
â”‚  â”‚   6. Append findings to planning-progress.md                             â”‚   â”‚
â”‚  â”‚   7. Reviewer checks plan; refine until SHIP or max passes               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                               â”‚
â”‚                                 â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           TASKS CREATED                                  â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚   task-1: Setup types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â”‚
â”‚  â”‚   task-2: Core logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ depends on task-1          â”‚   â”‚
â”‚  â”‚   task-3: API endpoints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚   â”‚
â”‚  â”‚   task-4: Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ depends on task-2, task-3  â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: WORK EXECUTION                                      pi_messenger({   â”‚
â”‚                                                                action: "work"}) â”‚
â”‚                                                                                  â”‚
â”‚   Ready tasks â”€â”€â–º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   (deps met)       â”‚                 WORKERS (parallel)                      â”‚   â”‚
â”‚                    â”‚                                                         â”‚   â”‚
â”‚                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚                    â”‚   â”‚   worker    â”‚    â”‚   worker    â”‚   concurrency: 2  â”‚   â”‚
â”‚                    â”‚   â”‚   (opus)    â”‚    â”‚   (opus)    â”‚                   â”‚   â”‚
â”‚                    â”‚   â”‚             â”‚    â”‚             â”‚                   â”‚   â”‚
â”‚                    â”‚   â”‚  task-1     â”‚    â”‚  task-3     â”‚                   â”‚   â”‚
â”‚                    â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚                    â”‚          â”‚                  â”‚                          â”‚   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                  â”‚                              â”‚
â”‚                               â–¼                  â–¼                              â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                         â”‚   Done   â”‚       â”‚   Done   â”‚                        â”‚
â”‚                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                              â”‚                  â”‚                               â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         REVIEW (per task)                                â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚   â”‚
â”‚  â”‚                      â”‚      reviewer       â”‚                             â”‚   â”‚
â”‚  â”‚                      â”‚   (gpt-5.2-high)    â”‚                             â”‚   â”‚
â”‚  â”‚                      â”‚                     â”‚                             â”‚   â”‚
â”‚  â”‚                      â”‚ Code quality, docs, â”‚                             â”‚   â”‚
â”‚  â”‚                      â”‚ correctness, style  â”‚                             â”‚   â”‚
â”‚  â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚   â”‚
â”‚  â”‚                                 â”‚                                        â”‚   â”‚
â”‚  â”‚                                 â–¼                                        â”‚   â”‚
â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚          â”‚  SHIP âœ…  â”‚  NEEDS_WORK ğŸ”„  â”‚  MAJOR_RETHINK âŒ â”‚               â”‚   â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  AUTONOMOUS MODE (autonomous: true)                                      â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   Wave 1 â”€â”€â–º Wave 2 â”€â”€â–º Wave 3 â”€â”€â–º ... â”€â”€â–º All done or blocked          â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   Continues until:                                                       â”‚   â”‚
â”‚   â”‚   â€¢ All tasks completed                                                  â”‚   â”‚
â”‚   â”‚   â€¢ All remaining tasks blocked (no ready tasks)                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Note:** Plan review is automatic inside the planning loop; implementation review is a separate manual action (`action: "review"`).

## Model Summary

| Role | Model | Agents |
|------|-------|--------|
| Planner | `claude-opus-4-5` | planner |
| Analyst | `claude-opus-4-5` | interview-generator, plan-sync |
| Worker | `claude-opus-4-5` | worker |
| Reviewer | `openai/gpt-5.2-high` | reviewer |

## Agent Inventory

### Planner (1)

| Agent | Model | Purpose |
|-------|-------|---------|
| `crew-planner` | opus | Analyzes codebase and PRD, produces task breakdown |

### Analysts (2)

| Agent | Model | Purpose |
|-------|-------|---------|
| `crew-interview-generator` | opus | Generates clarifying questions |
| `crew-plan-sync` | opus | Updates downstream task specs after changes |

### Workers (1)

| Agent | Model | Purpose |
|-------|-------|---------|
| `crew-worker` | opus | Implements tasks, writes code |

### Reviewers (1)

| Agent | Model | Purpose |
|-------|-------|---------|
| `crew-reviewer` | gpt-5.2-high | Code review with SHIP/NEEDS_WORK/MAJOR_RETHINK verdicts |

## Data Storage

```
.pi/messenger/crew/
â”œâ”€â”€ plan.json                 # Plan metadata (PRD path, task counts)
â”œâ”€â”€ plan.md                   # Planner output (task breakdown)
â”œâ”€â”€ planning-progress.md      # Planning loop history + reviewer feedback
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ task-1.json           # Task metadata (status, deps, attempts)
â”‚   â”œâ”€â”€ task-1.md             # Task specification
â”‚   â”œâ”€â”€ task-2.json
â”‚   â””â”€â”€ task-2.md
â”œâ”€â”€ blocks/
â”‚   â””â”€â”€ task-3.md             # Block context (if blocked)
â”œâ”€â”€ artifacts/                # Debug artifacts (flat, auto-cleaned)
â”‚   â”œâ”€â”€ {runId}_{agent}_input.md
â”‚   â”œâ”€â”€ {runId}_{agent}_output.md
â”‚   â”œâ”€â”€ {runId}_{agent}.jsonl
â”‚   â””â”€â”€ {runId}_{agent}_meta.json
â””â”€â”€ config.json               # Project-level crew config
```

## Configuration

```json
{
  "crew": {
    "concurrency": {
      "workers": 2
    },
    "truncation": {
      "planners": { "bytes": 204800, "lines": 5000 },
      "workers": { "bytes": 204800, "lines": 5000 },
      "reviewers": { "bytes": 102400, "lines": 2000 },
      "analysts": { "bytes": 102400, "lines": 2000 }
    },
    "review": {
      "enabled": true,
      "maxIterations": 3
    },
    "planning": {
      "maxPasses": 3
    },
    "work": {
      "maxAttemptsPerTask": 5,
      "maxWaves": 50,
      "stopOnBlock": false
    },
    "artifacts": {
      "enabled": true,
      "cleanupDays": 7
    },
    "memory": { "enabled": false },
    "planSync": { "enabled": false }
  }
}
```

| Section | Description |
|---------|-------------|
| `concurrency` | Parallel execution limits (workers only; planner always runs as a single agent) |
| `truncation` | Output size limits per agent role |
| `review` | Auto-review settings (note: `enabled` and `maxIterations` defined but not enforced) |
| `planning` | Planning loop settings (`maxPasses`, set to 1 for single-pass) |
| `work` | Execution limits (note: `maxWaves` and `maxAttemptsPerTask` defined but not enforced) |
| `artifacts` | Debug artifact storage |
| `memory` | Memory system (not yet implemented) |
| `planSync` | Auto-sync downstream specs (not yet implemented) |

## Task IDs

Simple format: `task-1`, `task-2`, `task-3`, ...

No epic prefixes needed.
